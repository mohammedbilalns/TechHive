<%- include('../partials/adminheader') %>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<div class="flex min-h-screen">
  <!-- Sidebar -->
  <aside id="sidebar" class="bg-gray-100 w-full md:w-64 h-screen">
    <nav class="py-4">
      <div class="px-4 md:px-6">
        <h2 class="text-sm font-semibold text-gray-600 uppercase">Menu</h2>
        <ul class="mt-4 space-y-2">
          <li>
            <a href="/admin/dashboard" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-th-large mr-3"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li>
            <a href="/admin/products" class="flex items-center px-4 py-2 bg-primary-accent text-gray-200 hover:bg-primary-hover rounded-lg">
              <i class="fas fa-box mr-3"></i>
              <span>Products</span>
            </a>
          </li>
          <li>
            <a href="/admin/categories" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-layer-group mr-3"></i>
              <span>Category</span>
            </a>
          </li>
          <li>
            <a href="/admin/orders" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-shopping-cart mr-3"></i>
              <span>Orders</span>
            </a>
          </li>
          <li>
            <a href="/admin/coupons" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-ticket-alt mr-3"></i>
              <span>Coupon</span>
            </a>
          </li>
          <li>
            <a href="/admin/banners" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-images mr-3"></i>
              <span>Banner</span>
            </a>
          </li>
          <li>
            <a href="/transactions" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-receipt mr-3"></i>
              <span>Transaction</span>
            </a>
          </li>
        </ul>
      </div>
      <div class="px-4 md:px-6 mt-8">
        <h2 class="text-sm font-semibold text-gray-600 uppercase">User Management</h2>
        <ul class="mt-4 space-y-2">
          <li>
            <a href="/admin/admins" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-user-shield mr-3"></i>
              <span>Manage Admins</span>
            </a>
          </li>
          <li>
            <a href="/admin/customers" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-users mr-3"></i>
              <span>Customers</span>
            </a>
          </li>
        </ul>
      </div>
      <div class="px-4 md:px-6 mt-8">
        <h2 class="text-sm font-semibold text-gray-600 uppercase">Others</h2>
        <ul class="mt-4 space-y-2">
          <li>
            <a href="/admin/settings" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-cogs mr-3"></i>
              <span>Settings</span>
            </a>
          </li>
          <li>
            <a href="/admin/help" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-question-circle mr-3"></i>
              <span>Help</span>
            </a>
          </li>
          <li>
            <a href="/admin/logout" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-lg">
              <i class="fas fa-sign-out-alt mr-3"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-grow p-4 md:py-6 bg-gray-50">
    <h1 class="text-2xl font-bold text-gray-800">Add New Product</h1>
   <!-- Add Product Form -->
<div id="productFormContainer" class="bg-white shadow-lg rounded-lg p-8 mt-4">
  <form id="addProductForm" action="/admin/products/add" method="POST" enctype="multipart/form-data">
    <!-- Product Name -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
      <input type="text" name="name" class="w-full h-12 px-4 py-2 text-base rounded-lg border border-gray-300 focus:border-blue-500" required placeholder="Enter product name">
    </div>
    
    <!-- Product Description -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Product Description</label>
      <textarea name="description" class="w-full h-24 px-4 py-2 text-base rounded-lg border border-gray-300 focus:border-blue-500" required placeholder="Enter product description"></textarea>
    </div>
    
    <!-- Price -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Price</label>
      <input type="number" name="price" class="w-full h-12 px-4 py-2 text-base rounded-lg border border-gray-300 focus:border-blue-500" required placeholder="Enter product price" step="0.01">
    </div>
    
    <!-- Discount Percentage -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Discount Percentage</label>
      <input type="number" name="discount" class="w-full h-12 px-4 py-2 text-base rounded-lg border border-gray-300 focus:border-blue-500" placeholder="Enter discount percentage" min="0" max="100" step="0.01">
    </div>
    
    <!-- Stock -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Stock</label>
      <input type="number" name="stock" class="w-full h-12 px-4 py-2 text-base rounded-lg border border-gray-300 focus:border-blue-500" required placeholder="Enter stock quantity" min="0">
    </div>
    
    <!-- Brand -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
      <input type="text" name="brand" class="w-full h-12 px-4 py-2 text-base rounded-lg border border-gray-300 focus:border-blue-500" required placeholder="Enter brand name">
    </div>
    
    <!-- Category -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
      <select name="category" class="w-full h-12 px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500" required>
        <option value="">Select Category</option>
        <% categories.forEach(category => { %>
          <option value="<%= category._id %>"><%= category.name %></option>
        <% }); %>
      </select>
    </div>
    
    <!-- Variant -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Variant</label>
      <input type="text" name="variant" class="w-full h-12 px-4 py-2 text-base rounded-lg border border-gray-300 focus:border-blue-500" required placeholder="Enter product variant">
    </div>
    
    <!-- Main Image -->
    <div class="form-group mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Images</label>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="w-full">
          <label class="block">
            <input type="file" name="mainImages" accept="image/*" class="hidden" required onchange="handleImageUpload(this, 'preview1', 'uploadLabel1', 'cropperModal', 'cropperImage')">
            <span id="uploadLabel1" class="flex items-center justify-center h-20 w-20 border border-gray-300 bg-white text-gray-800 cursor-pointer hover:bg-gray-100 transition duration-200 ease-in-out">
              <i class="fas fa-plus text-3xl"></i>
            </span>
          </label>
          <div id="preview1" class="mt-2 hidden">
            <img src="" alt="Preview 1" class="h-20 w-20 object-cover rounded">
          </div>
        </div>
        <div class="w-full">
          <label class="block">
            <input type="file" name="mainImages" accept="image/*" class="hidden" required onchange="handleImageUpload(this, 'preview2', 'uploadLabel2', 'cropperModal', 'cropperImage')">
            <span id="uploadLabel2" class="flex items-center justify-center h-20 w-20 border border-gray-300 bg-white text-gray-800 cursor-pointer hover:bg-gray-100 transition duration-200 ease-in-out">
              <i class="fas fa-plus text-3xl"></i>
            </span>
          </label>
          <div id="preview2" class="mt-2 hidden">
            <img src="" alt="Preview 2" class="h-20 w-20 object-cover rounded">
          </div>
        </div>
        <div class="w-full">
          <label class="block">
            <input type="file" name="mainImages" accept="image/*" class="hidden" required onchange="handleImageUpload(this, 'preview3', 'uploadLabel3', 'cropperModal', 'cropperImage')">
            <span id="uploadLabel3" class="flex items-center justify-center h-20 w-20 border border-gray-300 bg-white text-gray-800 cursor-pointer hover:bg-gray-100 transition duration-200 ease-in-out">
              <i class="fas fa-plus text-3xl"></i>
            </span>
          </label>
          <div id="preview3" class="mt-2 hidden">
            <img src="" alt="Preview 3" class="h-20 w-20 object-cover rounded">
          </div>
        </div>
        <div class="w-full">
          <label class="block">
            <input type="file" name="mainImages" accept="image/*" class="hidden" required onchange="handleImageUpload(this, 'preview4', 'uploadLabel4', 'cropperModal', 'cropperImage')">
            <span id="uploadLabel4" class="flex items-center justify-center h-20 w-20 border border-gray-300 bg-white text-gray-800 cursor-pointer hover:bg-gray-100 transition duration-200 ease-in-out">
              <i class="fas fa-plus text-3xl"></i>
            </span>
          </label>
          <div id="preview4" class="mt-2 hidden">
            <img src="" alt="Preview 4" class="h-20 w-20 object-cover rounded">
          </div>
        </div>
      </div>
      <small class="text-gray-500">Please upload 4 images.</small>
    </div> 
  </form>

  <!-- Add Product Button -->
  <div id="addProductButtonContainer" class="flex justify-end mt-6">
    <button type="submit" form="addProductForm" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Product</button>
  </div>
</div>

<!-- Cropper Modal -->
<div id="cropperModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Crop Image</h3>
      <button onclick="closeCropper()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="relative aspect-square mb-4">
      <img id="cropperImage" src="#" class="max-w-full">
    </div>
    <div class="flex justify-end gap-3">
      <button onclick="closeCropper()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Cancel</button>
      <button class="apply-button px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="applyCrop()">Apply</button>
    </div>
  </div>
</div>

<script>
 document.addEventListener("DOMContentLoaded", () => {
  const addProductForm = document.getElementById("addProductForm");
  let cropper;
  let currentImageInput;
  let currentPreviewId;
  let currentUploadLabelId;

  function handleImageUpload(input, previewId, uploadLabelId, modalId, cropperImageId) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      currentImageInput = input;
      currentPreviewId = previewId;
      currentUploadLabelId = uploadLabelId;
      
      reader.onload = function(e) {
        const cropperImg = document.getElementById(cropperImageId);
        cropperImg.src = e.target.result;
        
        document.getElementById(modalId).style.display = 'flex';
        
        if (cropper) {
          cropper.destroy();
        }
        
        cropper = new Cropper(cropperImg, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          background: false,
          zoomable: true,
          scalable: true
        });
      };
      
      reader.readAsDataURL(input.files[0]);
    }
  }

  function closeCropper() {
    document.getElementById("cropperModal").style.display = 'none';
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
  }

  function applyCrop() {
    if (cropper) {
      const canvas = cropper.getCroppedCanvas();
      canvas.toBlob((blob) => {
        const file = new File([blob], "croppedImage.png", { type: "image/png" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        currentImageInput.files = dataTransfer.files;

        // Show preview
        const previewContainer = document.getElementById(currentPreviewId);
        const previewImg = previewContainer.querySelector('img');
        const uploadLabel = document.getElementById(currentUploadLabelId);
        
        previewImg.src = canvas.toDataURL();
        previewContainer.classList.remove('hidden');
        uploadLabel.classList.add('hidden');
        
        closeCropper();
      });
    }
  }

  addProductForm.addEventListener("submit", (event) => {
    event.preventDefault();
    const formData = new FormData(addProductForm);

    fetch("/admin/products/add", {
      method: "POST",
      body: formData,
    })
      .then((response) => {
        if (response.ok) {
          alert("Product added successfully!");
          location.reload();
          addProductForm.reset();
        } else {
          alert("Failed to add product!");
        }
      })
      .catch((error) => console.error("Error submitting form:", error));
  });

  window.handleImageUpload = handleImageUpload;
  window.closeCropper = closeCropper;
  window.applyCrop = applyCrop;
});
</script>